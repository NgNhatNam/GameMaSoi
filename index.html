<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qu·∫£n Tr√≤ Ma S√≥i Ultimate</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Creepster&family=Roboto:wght@300;400;500;700;900&display=swap');
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #000000;
            color: #e5e5e5;
            overscroll-behavior: none;
            background-image: radial-gradient(circle at 50% 30%, #1a1a00 0%, #000000 100%); /* √Ånh v√†ng nh·∫π ma qu√°i */
            min-height: 100vh;
        }
        
        .font-spooky {
            font-family: 'Creepster', cursive;
            letter-spacing: 3px;
        }

        .text-glow { text-shadow: 0 0 10px rgba(220, 38, 38, 0.6); }
        .text-glow-yellow { text-shadow: 0 0 10px rgba(234, 179, 8, 0.6); }
        .text-glow-blue { text-shadow: 0 0 10px rgba(59, 130, 246, 0.6); }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #0f0f0f; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 2px; }
        
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.96);
            backdrop-filter: blur(4px);
        }

        .role-card {
            background: rgba(30, 30, 30, 0.6);
            border: 1px solid rgba(80, 80, 80, 0.5);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            transition: all 0.2s ease;
        }
        .role-card:active { transform: scale(0.98); }

        .animate-pulse-slow { animation: pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        .btn-normal {
            font-family: 'Roboto', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONS ---
        const Icon = ({ p, children, className="" }) => (
            <svg {...p} xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Moon = p => <Icon p={p}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></Icon>;
        const Users = p => <Icon p={p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></Icon>;
        const Eye = p => <Icon p={p}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></Icon>;
        const Shield = p => <Icon p={p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/></Icon>;
        const Flask = p => <Icon p={p}><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/></Icon>;
        const Gavel = p => <Icon p={p}><path d="m14.5 12.5-8 8a2.121 2.121 0 0 1-3-3l8-8"/><path d="m16 16 6-6"/><path d="m8 8 6-6"/><path d="m9 7 8 8"/><path d="m21 11-8-8"/></Icon>;
        const Heart = p => <Icon p={p}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></Icon>;
        const Ghost = p => <Icon p={p}><path d="M9 22v-3h6v3" /><path d="M4 22V9a8 8 0 0 1 16 0v13" /><circle cx="9" cy="10" r="1.5" /><circle cx="15" cy="10" r="1.5" /><path d="M10 16a2 2 0 1 0 4 0" /></Icon>;
        const Star = p => <Icon p={p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></Icon>;
        const PawPrint = p => <Icon p={p}><circle cx="12" cy="12" r="3"/><circle cx="19" cy="5" r="3"/><circle cx="5" cy="5" r="3"/><circle cx="19" cy="19" r="3"/><circle cx="5" cy="19" r="3"/></Icon>;
        const UserX = p => <Icon p={p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="18" x2="23" y1="8" y2="13"/><line x1="23" x2="18" y1="8" y2="13"/></Icon>;
        const Settings = p => <Icon p={p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Icon>;
        const Skull = p => <Icon p={p}><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="m12.5 17-.5-1-.5 1h1z"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/></Icon>;
        const Play = p => <Icon p={p}><polygon points="5 3 19 12 5 21 5 3"/></Icon>;
        const Pause = p => <Icon p={p}><rect width="4" height="16" x="6" y="4"/><rect width="4" height="16" x="14" y="4"/></Icon>;
        const RotateCcw = p => <Icon p={p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></Icon>;
        const X = p => <Icon p={p}><path d="M18 6 6 18"/><path d="m6 6 18 18"/></Icon>;
        const Save = p => <Icon p={p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>;
        const Plus = p => <Icon p={p}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>;
        const Check = p => <Icon p={p}><polyline points="20 6 9 17 4 12"/></Icon>;
        const AlertTriangle = p => <Icon p={p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></Icon>;
        const Trash = p => <Icon p={p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></Icon>;
        const Refresh = p => <Icon p={p}><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></Icon>;

        // --- CONSTANTS ---
        const DEFAULT_ROLES = [
            { id: 'villager', name: 'D√¢n L√†ng', team: 'good', defaultCount: 3, icon: Users, desc: 'Kh√¥ng c√≥ ch·ª©c nƒÉng ƒë·∫∑c bi·ªát. Ng·ªß ngon v√† c·ªë g·∫Øng kh√¥ng ch·∫øt.', isDefault: true },
            { id: 'werewolf', name: 'Ma S√≥i', team: 'bad', defaultCount: 2, icon: Moon, desc: 'D·∫≠y ƒë√™m c·∫Øn ng∆∞·ªùi. H√£y gi·∫£ nai v√†o ban ng√†y.', isDefault: true },
            { id: 'seer', name: 'Ti√™n Tri', team: 'good', defaultCount: 1, icon: Eye, desc: 'M·ªói ƒë√™m soi m·ªôt ng∆∞·ªùi ƒë·ªÉ bi·∫øt phe c·ªßa h·ªç. Nh√¢n v·∫≠t quan tr·ªçng!', isDefault: true },
            { id: 'bodyguard', name: 'B·∫£o V·ªá', team: 'good', defaultCount: 1, icon: Shield, desc: 'Ch·ªçn b·∫£o v·ªá 1 ng∆∞·ªùi m·ªói ƒë√™m. Kh√¥ng ƒë∆∞·ª£c b·∫£o v·ªá 1 ng∆∞·ªùi 2 ƒë√™m li√™n ti·∫øp.', isDefault: true },
            { id: 'witch', name: 'Ph√π Th·ªßy', team: 'good', defaultCount: 1, icon: Flask, desc: 'C√≥ 1 B√¨nh C·ª©u v√† 1 B√¨nh ƒê·ªôc. D√πng c·∫©n th·∫≠n.', isDefault: true },
            { id: 'hunter', name: 'Th·ª£ SƒÉn', team: 'good', defaultCount: 0, icon: Gavel, desc: 'N·∫øu b·∫°n ch·∫øt, b·∫°n ƒë∆∞·ª£c k√©o theo 1 ng∆∞·ªùi kh√°c ch·∫øt chung.', isDefault: true },
            { id: 'cupid', name: 'Th·∫ßn T√¨nh Y√™u', team: 'good', defaultCount: 0, icon: Heart, desc: 'ƒê√™m ƒë·∫ßu ti√™n, gh√©p ƒë√¥i 2 ng∆∞·ªùi. H·ªç s·ªëng ch·∫øt c√≥ nhau.', isDefault: true },
            { id: 'elder', name: 'Gi√† L√†ng', team: 'good', defaultCount: 0, icon: Star, desc: 'Ma S√≥i c·∫Øn l·∫ßn ƒë·∫ßu kh√¥ng ch·∫øt. B·ªã treo c·ªï th√¨ m·∫•t h·∫øt ch·ª©c nƒÉng ƒë·∫∑c bi·ªát c·ªßa l√†ng.', hp: 2, isDefault: true },
            { id: 'lycan', name: 'B√°n S√≥i', team: 'good', defaultCount: 0, icon: PawPrint, desc: 'Ban ƒë·∫ßu l√† D√¢n. N·∫øu b·ªã S√≥i c·∫Øn, kh√¥ng ch·∫øt m√† h√≥a th√†nh S√≥i.', isDefault: true },
            { id: 'minion', name: 'Ph·∫£n B·ªôi', team: 'bad', defaultCount: 0, icon: UserX, desc: 'Phe S√≥i nh∆∞ng kh√¥ng d·∫≠y c·∫Øn. D·∫≠y ri√™ng ƒë·ªÉ bi·∫øt S√≥i l√† ai.', isDefault: true },
            { id: 'jester', name: 'K·∫ª Ch√°n ƒê·ªùi', team: 'neutral', defaultCount: 0, icon: Ghost, desc: 'M·ª•c ti√™u duy nh·∫•t: H√£y l√†m cho m·ªçi ng∆∞·ªùi treo c·ªï b·∫°n.', isDefault: true },
        ];

        // --- UPDATED STATUS TAGS WITH EFFECTS ---
        // Effects: 'kill' (Hard kill/Poison), 'damage' (Soft kill/Bite), 'save' (Save/Protect), 'none' (Info only)
        const DEFAULT_STATUS_TAGS = [
            { id: 'bitten', label: 'C·∫ÆN', emoji: 'üê∫', color: 'bg-red-800 text-white border-red-500', effect: 'damage' },
            { id: 'poisoned', label: 'ƒê·ªòC', emoji: 'ü§¢', color: 'bg-green-800 text-white border-green-600', effect: 'kill' },
            { id: 'protected', label: 'SHIELD', emoji: 'üõ°Ô∏è', color: 'bg-blue-600 text-white border-blue-400', effect: 'save' },
            { id: 'saved', label: 'C·ª®U', emoji: 'üíâ', color: 'bg-green-600 text-white border-green-400', effect: 'save' },
            { id: 'silenced', label: 'C√ÇM', emoji: 'ü§ê', color: 'bg-gray-500 text-white border-gray-400', effect: 'none' },
            { id: 'target', label: 'SOI', emoji: 'üëÅÔ∏è', color: 'bg-yellow-600 text-white border-yellow-400', effect: 'none' },
            { id: 'love', label: 'Y√äU', emoji: '‚ù§Ô∏è', color: 'bg-pink-600 text-white border-pink-400', effect: 'none', isPersistent: true },
        ];

        const NIGHT_STEPS_DEF = [
            { id: 'start', title: 'ƒê√äM XU·ªêNG', msg: 'T·∫•t c·∫£ nh·∫Øm m·∫Øt l·∫°i.' },
            { id: 'cupid', title: 'TH·∫¶N T√åNH Y√äU', msg: 'D·∫≠y gh√©p ƒë√¥i n√†o.', roleId: 'cupid', limit: 1 },
            { id: 'lovers', title: 'C·∫∂P ƒê√îI', msg: 'Hai ng∆∞·ªùi y√™u nhau m·ªü m·∫Øt nh√¨n nhau.', roleId: 'cupid', limit: 1, dependency: true },
            { id: 'guard', title: 'B·∫¢O V·ªÜ', msg: 'B·∫°n mu·ªën b·∫£o v·ªá ai?', roleId: 'bodyguard' },
            { id: 'werewolf', title: 'MA S√ìI', msg: 'ƒê√™m nay c·∫Øn ai?', roleId: 'werewolf' },
            { id: 'minion', title: 'PH·∫¢N B·ªòI', msg: 'D·∫≠y t√¨m ƒë·ªìng ƒë·ªôi.', roleId: 'minion', limit: 1 },
            { id: 'witch', title: 'PH√ô TH·ª¶Y', msg: 'C√≥ c·ª©u hay gi·∫øt ai kh√¥ng?', roleId: 'witch' },
            { id: 'seer', title: 'TI√äN TRI', msg: 'B·∫°n mu·ªën soi ai?', roleId: 'seer' },
            { id: 'elder', title: 'GI√Ä L√ÄNG', msg: 'G·ªçi ƒë·ªÉ x√°c nh·∫≠n tr·∫°ng th√°i.', roleId: 'elder' },
            { id: 'end', title: 'TR·ªúI S√ÅNG', msg: 'M·ªçi ng∆∞·ªùi th·ª©c d·∫≠y!' }
        ];

        // --- COMPONENTS ---
        const Modal = ({ children, onClose }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4" onClick={onClose}>
                <div className="bg-neutral-900 border-2 border-red-900/50 rounded-2xl w-full max-w-sm max-h-[85vh] overflow-hidden animate-fadeIn relative shadow-[0_0_50px_rgba(220,38,38,0.2)] flex flex-col" onClick={e=>e.stopPropagation()}>
                    {children}
                </div>
            </div>
        );

        const AddTagModal = ({ onClose, onAdd }) => {
            const [label, setLabel] = useState("");
            const [emoji, setEmoji] = useState("üîÆ");
            const [effect, setEffect] = useState("none");

            return (
                <Modal onClose={onClose}>
                    <div className="p-6 overflow-y-auto">
                        <h3 className="text-2xl font-bold text-yellow-500 mb-4 text-center font-spooky tracking-wider">T·∫°o Tr·∫°ng Th√°i M·ªõi</h3>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-400 uppercase mb-1">T√™n Tr·∫°ng Th√°i</label>
                                <input className="w-full bg-black border border-neutral-700 rounded-lg p-3 text-white focus:border-yellow-500 outline-none" placeholder="VD: B·ªã Th√¥i Mi√™n" value={label} onChange={e=>setLabel(e.target.value)} />
                            </div>
                            
                            <div>
                                <label className="block text-xs font-bold text-gray-400 uppercase mb-1">Bi·ªÉu T∆∞·ª£ng (Icon/Emoji)</label>
                                <input className="w-full bg-black border border-neutral-700 rounded-lg p-3 text-white text-center text-2xl focus:border-yellow-500 outline-none" value={emoji} onChange={e=>setEmoji(e.target.value)} />
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-gray-400 uppercase mb-1">Ch·ª©c NƒÉng (Effect)</label>
                                <select className="w-full bg-black border border-neutral-700 rounded-lg p-3 text-white outline-none" value={effect} onChange={e=>setEffect(e.target.value)}>
                                    <option value="none">V√¥ h·∫°i (ƒê√°nh d·∫•u)</option>
                                    <option value="kill">G√¢y Ch·∫øt (M·∫°nh - Kh√¥ng c·ª©u ƒë∆∞·ª£c)</option>
                                    <option value="damage">S√°t Th∆∞∆°ng (Y·∫øu - C·ª©u ƒë∆∞·ª£c)</option>
                                    <option value="save">C·ª©u / B·∫£o V·ªá</option>
                                </select>
                            </div>

                            <div className="flex gap-3 pt-2">
                                <button onClick={onClose} className="btn-normal flex-1 py-3 bg-neutral-800 hover:bg-neutral-700 rounded-lg text-gray-400">H·ªßy</button>
                                <button onClick={() => { if(label) { onAdd({ id: Date.now().toString(), label, emoji, effect, color: 'bg-purple-600 text-white border-purple-400' }); onClose(); } }} className="btn-normal flex-1 py-3 bg-yellow-700 hover:bg-yellow-600 rounded-lg text-white">T·∫†O</button>
                            </div>
                        </div>
                    </div>
                </Modal>
            )
        };

        const PlayerActionModal = ({ player, roles, tags, onClose, onUpdate, onKill, onRevive, onAddTag }) => {
            const [showAddTag, setShowAddTag] = useState(false);

            if (showAddTag) return <AddTagModal onClose={()=>setShowAddTag(false)} onAdd={onAddTag} />;
            if (!player) return null;

            return (
                <Modal onClose={onClose}>
                    <div className="bg-black/50 p-4 flex justify-between items-center border-b border-red-900/30 shrink-0">
                        <h3 className="text-xl font-bold text-white flex items-center gap-2 truncate text-glow">
                            <Settings size={24} className="text-red-500"/>
                            {player.name}
                        </h3>
                        <button onClick={onClose} className="text-gray-400 hover:text-red-500 transition-colors p-2"><X /></button>
                    </div>

                    <div className="p-5 space-y-5 overflow-y-auto">
                        {/* Vai Tr√≤ */}
                        <div>
                            <label className="block text-xs font-bold text-red-500 uppercase mb-2 tracking-wider">Vai Tr√≤ Hi·ªán T·∫°i</label>
                            <select 
                                value={player.roleId} 
                                onChange={(e) => onUpdate(player.id, { roleId: e.target.value })}
                                className="w-full bg-neutral-800 border border-neutral-700 text-gray-200 rounded-lg p-3 focus:border-red-500 focus:ring-1 focus:ring-red-500 outline-none font-bold"
                            >
                                {roles.map(r => (
                                    <option key={r.id} value={r.id}>
                                        {r.name}
                                    </option>
                                ))}
                            </select>
                        </div>

                        {/* HP */}
                        {player.hp !== undefined && (
                            <div>
                                <label className="block text-xs font-bold text-red-500 uppercase mb-2 tracking-wider">M·∫°ng S·ªëng</label>
                                <div className="flex items-center gap-4 bg-neutral-800 p-2 rounded-lg border border-neutral-700">
                                    <button onClick={() => onUpdate(player.id, { hp: Math.max(0, player.hp - 1) })} className="w-12 h-12 bg-red-900/50 hover:bg-red-800 rounded-lg font-bold text-white border border-red-700 flex items-center justify-center text-xl transition-all">-</button>
                                    <span className="text-3xl font-bold text-white flex-1 text-center text-glow">{player.hp}</span>
                                    <button onClick={() => onUpdate(player.id, { hp: player.hp + 1 })} className="w-12 h-12 bg-green-900/50 hover:bg-green-800 rounded-lg font-bold text-white border border-green-700 flex items-center justify-center text-xl transition-all">+</button>
                                </div>
                            </div>
                        )}

                        {/* Tags */}
                        <div>
                            <div className="flex justify-between items-center mb-2">
                                <label className="block text-xs font-bold text-red-500 uppercase tracking-wider">Tr·∫°ng Th√°i (Tags)</label>
                                <button onClick={()=>setShowAddTag(true)} className="text-[10px] bg-neutral-800 border border-neutral-600 px-2 py-1 rounded hover:bg-neutral-700 flex items-center gap-1">+ TH√äM</button>
                            </div>
                            <div className="grid grid-cols-3 gap-2">
                                {tags.map(tag => {
                                    const isActive = (player.tags || []).includes(tag.id);
                                    return (
                                        <button
                                            key={tag.id}
                                            onClick={() => {
                                                const newTags = isActive ? player.tags.filter(t => t !== tag.id) : [...(player.tags||[]), tag.id];
                                                onUpdate(player.id, { tags: newTags });
                                            }}
                                            className={`py-3 rounded-lg text-xs font-bold border-2 transition-all flex flex-col items-center justify-center gap-1 relative overflow-hidden group min-h-[70px]
                                                ${isActive ? `${tag.color} shadow-[0_0_10px_currentColor]` : 'bg-neutral-800 border-neutral-700 text-gray-500 hover:border-gray-500'}`}
                                        >
                                            <span className="text-2xl z-10">{tag.emoji}</span>
                                            <span className="text-[10px] tracking-widest z-10 text-center px-1">{tag.label}</span>
                                            {isActive && <div className="absolute inset-0 bg-white/10 animate-pulse"></div>}
                                        </button>
                                    );
                                })}
                            </div>
                        </div>

                        {/* Kill/Revive */}
                        <div className="pt-4 border-t border-red-900/30">
                            {player.isAlive ? (
                                <button onClick={() => { onKill(player.id); onClose(); }} className="btn-normal w-full bg-gradient-to-r from-red-900 to-red-800 hover:from-red-800 hover:to-red-700 text-white py-4 rounded-xl flex justify-center items-center gap-3 text-xl shadow-lg shadow-red-900/30 border border-red-700 transition-all hover:scale-[1.02]">
                                    <Skull size={24} /> KHAI T·ª¨
                                </button>
                            ) : (
                                <button onClick={() => { onRevive(player.id); onClose(); }} className="btn-normal w-full bg-gradient-to-r from-green-900 to-green-800 hover:from-green-800 hover:to-green-700 text-white py-4 rounded-xl flex justify-center items-center gap-3 text-xl shadow-lg shadow-green-900/30 border border-green-700 transition-all hover:scale-[1.02]">
                                    <RotateCcw size={24} /> H·ªíI SINH
                                </button>
                            )}
                        </div>
                    </div>
                </Modal>
            );
        };

        const RevealRoleModal = ({ player, roleConfig, onClose }) => {
            if (!player || !roleConfig) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4" onClick={onClose}>
                     <div className="bg-neutral-900 rounded-2xl shadow-[0_0_60px_rgba(0,0,0,0.9)] border-2 border-neutral-700 w-full max-w-sm overflow-hidden relative group max-h-[85vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <div className="absolute inset-0 bg-red-500/5 pointer-events-none"></div>
                        
                        <div className="p-8 flex flex-col items-center text-center animate-fadeIn relative z-10">
                            <h3 className="text-lg text-gray-400 font-bold mb-6 uppercase tracking-[4px] border-b border-red-900/50 pb-2 w-full">Danh t√≠nh c·ªßa {player.name}</h3>
                            
                            <div className={`w-40 h-40 rounded-full flex items-center justify-center mb-6 shadow-[0_0_30px_rgba(0,0,0,0.8)] border-4 ${roleConfig.team === 'bad' ? 'bg-red-950 border-red-600 text-red-500' : (roleConfig.team==='neutral'?'bg-yellow-950 border-yellow-600 text-yellow-500':'bg-blue-950 border-blue-600 text-blue-500')} relative shrink-0`}>
                                <div className="absolute inset-0 rounded-full bg-black/20"></div>
                                {roleConfig.icon ? <roleConfig.icon size={80} className="relative z-10 drop-shadow-lg"/> : <Star size={80}/>}
                            </div>
                            
                            <h2 className={`text-4xl md:text-5xl mb-4 text-glow tracking-widest font-bold uppercase ${roleConfig.team === 'bad' ? 'text-red-500' : (roleConfig.team === 'neutral' ? 'text-yellow-500' : 'text-blue-500')}`}>
                                {roleConfig.name}
                            </h2>
                            
                            <p className="text-gray-300 mb-8 text-lg italic leading-relaxed border-t border-b border-white/5 py-4 w-full bg-black/20">
                                "{roleConfig.desc}"
                            </p>
                            
                            <button 
                                onClick={onClose}
                                className="btn-normal w-full py-4 bg-neutral-800 hover:bg-neutral-700 text-white rounded-xl border border-neutral-600 flex items-center justify-center gap-2 text-xl tracking-widest transition-all hover:scale-105"
                            >
                                <Check size={28}/> ƒê√É HI·ªÇU
                            </button>
                        </div>
                    </div>
                </div>
            )
        }

        const AddRoleModal = ({ onClose, onAdd }) => {
            const [name, setName] = useState("");
            const [desc, setDesc] = useState("");
            const [team, setTeam] = useState("good");
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4" onClick={onClose}>
                    <div className="bg-neutral-900 rounded-2xl border-2 border-neutral-700 w-full max-w-sm p-6 shadow-2xl max-h-[85vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
                        <h3 className="text-3xl font-bold text-red-500 mb-6 text-center text-glow tracking-widest uppercase font-spooky">Th√™m Vai Tr√≤ M·ªõi</h3>
                        <input className="w-full mb-4 bg-black border border-neutral-700 rounded-lg p-3 text-white placeholder-gray-600 focus:border-red-500 outline-none" placeholder="T√™n vai tr√≤ (VD: S√≥i L·ª≠a)" value={name} onChange={e=>setName(e.target.value)} />
                        <select className="w-full mb-4 bg-black border border-neutral-700 rounded-lg p-3 text-white outline-none" value={team} onChange={e=>setTeam(e.target.value)}>
                            <option value="good">Phe D√¢n (T·ªët)</option>
                            <option value="bad">Phe S√≥i (X·∫•u)</option>
                            <option value="neutral">Phe Th·ª© 3 (V√†ng)</option>
                        </select>
                        <input className="w-full mb-6 bg-black border border-neutral-700 rounded-lg p-3 text-white placeholder-gray-600 focus:border-red-500 outline-none" placeholder="M√¥ t·∫£ ng·∫Øn..." value={desc} onChange={e=>setDesc(e.target.value)} />
                        <div className="flex gap-3">
                            <button onClick={onClose} className="btn-normal flex-1 py-3 bg-neutral-800 hover:bg-neutral-700 rounded-lg text-gray-400">H·ªßy</button>
                            <button onClick={() => { if(name) { onAdd({name, desc, team}); onClose(); } }} className="btn-normal flex-1 py-3 bg-red-700 hover:bg-red-600 rounded-lg text-white">TH√äM</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [phase, setPhase] = useState('SETUP'); 
            const [rolesConfig, setRolesConfig] = useState(() => JSON.parse(localStorage.getItem('rolesConfig')) || DEFAULT_ROLES);
            const [playerNamesInput, setPlayerNamesInput] = useState(() => localStorage.getItem('playerNamesInput') || "T√≠\nS·ª≠u\nD·∫ßn\nM√£o\nTh√¨n\nT·ªã\nNg·ªç\nM√πi");
            const [statusTags, setStatusTags] = useState(() => JSON.parse(localStorage.getItem('statusTags')) || DEFAULT_STATUS_TAGS);

            useEffect(() => {
                localStorage.setItem('rolesConfig', JSON.stringify(rolesConfig));
                localStorage.setItem('playerNamesInput', playerNamesInput);
                localStorage.setItem('statusTags', JSON.stringify(statusTags));
            }, [rolesConfig, playerNamesInput, statusTags]);

            const [players, setPlayers] = useState([]);
            const [dayCount, setDayCount] = useState(1);
            const [currentStepIdx, setCurrentStepIdx] = useState(0);
            
            const [activeTab, setActiveTab] = useState('control');
            const [editingPlayer, setEditingPlayer] = useState(null);
            const [showAddRole, setShowAddRole] = useState(false);
            const [showDead, setShowDead] = useState(false);
            const [revealId, setRevealId] = useState(null);
            const [timer, setTimer] = useState(120);
            const [isTimerRunning, setIsTimerRunning] = useState(false);

            const activeNightSteps = useMemo(() => {
                if (phase !== 'GAME_NIGHT') return [];
                const activeRoleIds = new Set(rolesConfig.filter(r => (r.count||0) > 0).map(r => r.id));
                players.forEach(p => activeRoleIds.add(p.roleId));
                return NIGHT_STEPS_DEF.filter(step => {
                    if (step.id === 'start' || step.id === 'end') return true;
                    if (step.limit && dayCount > step.limit) return false;
                    if (step.dependency && !activeRoleIds.has('cupid')) return false;
                    if (step.roleId && !activeRoleIds.has(step.roleId)) return false;
                    return true;
                });
            }, [phase, rolesConfig, players, dayCount]);

            const updateRoleCount = (id, delta) => {
                setRolesConfig(prev => prev.map(r => r.id === id ? { ...r, count: Math.max(0, (r.count??r.defaultCount) + delta) } : r));
            };

            const removeRole = (id) => {
                if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a vai tr√≤ n√†y?")) {
                    setRolesConfig(prev => prev.filter(r => r.id !== id));
                }
            };

            const addCustomTag = (newTag) => {
                setStatusTags(prev => [...prev, newTag]);
            };

            const startGame = () => {
                const totalSelected = rolesConfig.reduce((acc,r) => acc+(r.count||r.defaultCount||0),0);
                const names = playerNamesInput.split('\n').filter(n=>n.trim());
                if (totalSelected !== names.length) return alert(`L·ªách: ${totalSelected} vai tr√≤ / ${names.length} t√™n.`);
                
                let pool = [];
                rolesConfig.forEach(r => {
                    for(let i=0; i<(r.count??r.defaultCount); i++) pool.push(r.id);
                });
                pool = pool.sort(() => Math.random() - 0.5);

                const newPlayers = names.map((name, idx) => {
                    const roleId = pool[idx];
                    const r = rolesConfig.find(x => x.id === roleId);
                    return { id: idx+1, name, roleId, isAlive: true, tags: [], hp: r.hp||1 };
                });

                setPlayers(newPlayers);
                setPhase('REVEAL'); 
            };

            const startMainGame = () => {
                setPhase('GAME_NIGHT');
                setDayCount(1);
                setCurrentStepIdx(0);
                setTimer(120);
                setIsTimerRunning(false);
            };

            const endGame = () => {
                if(confirm("K·∫øt th√∫c game v√† tr·ªü v·ªÅ m√†n h√¨nh ch√≠nh? (Setup s·∫Ω ƒë∆∞·ª£c gi·ªØ nguy√™n)")) {
                    setPhase('SETUP');
                }
            };

            const nextStep = () => {
                if (currentStepIdx < activeNightSteps.length - 1) {
                    setCurrentStepIdx(p => p + 1);
                } else {
                    setPhase('GAME_DAY');
                    setTimer(180); setIsTimerRunning(false);
                }
            };
            
            const endDay = () => {
                if(confirm("Chuy·ªÉn sang ƒê√™m?")) {
                    setPhase('GAME_NIGHT');
                    setDayCount(p => p + 1);
                    setCurrentStepIdx(0);
                }
            };

            const clearNightTags = () => {
                if(!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ tr·∫°ng th√°i t·∫°m th·ªùi?")) return;
                
                setPlayers(prev => prev.map(p => {
                    // Keep only persistent tags
                    const persistentTags = p.tags.filter(tId => {
                        const tagDef = statusTags.find(t => t.id === tId);
                        return tagDef && tagDef.isPersistent;
                    });
                    return { ...p, tags: persistentTags };
                }));
            };

            const morningEvents = useMemo(() => {
                return players.filter(p => p.isAlive)
                    .map(p => {
                        let status = 'alive'; 
                        let msg = ''; 
                        let action = 'none';
                        let isSaved = false;

                        // Check saves first
                        const saveTags = p.tags.map(t => statusTags.find(x => x.id === t)).filter(x => x && x.effect === 'save');
                        if (saveTags.length > 0) isSaved = true;

                        // Check negative effects
                        p.tags.forEach(tId => {
                            const tag = statusTags.find(x => x.id === tId);
                            if (!tag) return;

                            if (tag.effect === 'kill') {
                                // Poison overrides save usually, but for custom kill let's assume it's lethal
                                status = 'dead'; msg = `Ch·∫øt do ${tag.label}`; action = 'kill';
                            } else if (tag.effect === 'damage') {
                                if (isSaved) {
                                    status = 'saved'; msg = 'ƒê∆∞·ª£c C·ª©u/B·∫£o V·ªá'; action = 'none';
                                } else if (p.roleId === 'elder' && p.hp > 1) {
                                    status = 'damaged'; msg = 'M·∫•t 1 M·∫°ng'; action = 'damage';
                                } else if (p.roleId === 'lycan') {
                                    status = 'transform'; msg = 'H√≥a S√≥i'; action = 'transform';
                                } else {
                                    status = 'dead'; msg = `Ch·∫øt do ${tag.label}`; action = 'kill';
                                }
                            }
                        });

                        if (status === 'alive') return null;
                        return { ...p, outcome: status, outcomeMsg: msg, action };
                    }).filter(Boolean);
            }, [players, statusTags]);

            const deadPlayers = useMemo(() => players.filter(p => !p.isAlive), [players]);

            useEffect(() => {
                let i;
                if (isTimerRunning && timer > 0) i = setInterval(()=>setTimer(t=>t-1), 1000);
                return () => clearInterval(i);
            }, [isTimerRunning, timer]);

            // --- RENDER ---
            if (phase === 'SETUP') {
                const totalSelected = rolesConfig.reduce((a,b) => a+(b.count||b.defaultCount||0),0);
                const totalNames = playerNamesInput.split('\n').filter(x=>x.trim()).length;
                return (
                    <div className="min-h-screen p-4 md:p-8 flex justify-center items-center">
                        <div className="w-full max-w-5xl space-y-8">
                            <h1 className="text-6xl md:text-8xl font-spooky text-red-600 text-center text-glow animate-pulse-slow tracking-widest">
                                MA S√ìI ULTIMATE
                            </h1>
                            
                            <div className="grid md:grid-cols-2 gap-8">
                                <div className="role-card p-6 rounded-2xl relative group">
                                    <div className="absolute inset-0 bg-red-900/5 rounded-2xl pointer-events-none group-hover:bg-red-900/10 transition-colors"></div>
                                    <div className="flex justify-between mb-4 items-end relative z-10">
                                        <h3 className="text-2xl md:text-3xl text-yellow-500 tracking-wider font-bold">Danh S√°ch ({totalNames})</h3>
                                        <span className="text-xs text-gray-500 flex items-center gap-1"><Save size={12}/> Saved</span>
                                    </div>
                                    <textarea 
                                        className="w-full h-60 md:h-80 bg-black/60 border border-neutral-700 rounded-xl p-4 text-gray-300 focus:border-red-500 focus:bg-black/80 outline-none resize-none font-sans text-lg leading-relaxed relative z-10 transition-colors"
                                        value={playerNamesInput}
                                        onChange={e => setPlayerNamesInput(e.target.value)}
                                        placeholder="Nh·∫≠p t√™n ng∆∞·ªùi ch∆°i (m·ªói d√≤ng 1 ng∆∞·ªùi)..."
                                    />
                                </div>

                                <div className="role-card p-6 rounded-2xl flex flex-col h-[500px] relative">
                                    <div className="flex justify-between items-center mb-4 relative z-10">
                                        <h3 className="text-2xl md:text-3xl text-blue-500 tracking-wider font-bold">Vai Tr√≤ <span className="text-xl">({totalSelected})</span></h3>
                                        <button onClick={()=>setShowAddRole(true)} className="text-xs bg-neutral-800 hover:bg-neutral-700 border border-neutral-600 px-3 py-1.5 rounded-lg font-bold text-gray-300 transition-colors btn-normal">+ T√ôY CH·ªàNH</button>
                                    </div>
                                    <div className="flex-1 overflow-y-auto pr-2 space-y-2 relative z-10 custom-scrollbar">
                                        {rolesConfig.map(role => {
                                            const count = role.count ?? role.defaultCount ?? 0;
                                            return (
                                                <div key={role.id} className="flex items-center justify-between bg-black/40 p-3 rounded-lg border border-neutral-800 hover:border-neutral-600 transition-all">
                                                    <div className="flex items-center gap-4 flex-1">
                                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center shrink-0 ${role.team === 'bad' ? 'bg-red-900/30 text-red-500' : (role.team==='neutral'?'bg-yellow-900/30 text-yellow-500':'bg-blue-900/30 text-blue-500')}`}>
                                                            {role.icon ? <role.icon size={20}/> : <Users size={20}/>}
                                                        </div>
                                                        <div className="truncate">
                                                            <div className="font-bold text-lg tracking-wide text-gray-300">{role.name}</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="flex items-center gap-3 shrink-0">
                                                        {!role.isDefault && (
                                                            <button onClick={() => removeRole(role.id)} className="w-8 h-8 bg-red-900/20 text-red-500 hover:bg-red-900 hover:text-white rounded flex items-center justify-center transition-colors">
                                                                <Trash size={14}/>
                                                            </button>
                                                        )}
                                                        <button onClick={()=>updateRoleCount(role.id, -1)} className="w-8 h-8 bg-neutral-800 hover:bg-neutral-700 rounded text-gray-400 font-bold">-</button>
                                                        <span className="w-6 text-center text-xl font-bold font-mono text-white">{count}</span>
                                                        <button onClick={()=>updateRoleCount(role.id, 1)} className="w-8 h-8 bg-neutral-800 hover:bg-neutral-700 rounded text-gray-400 font-bold">+</button>
                                                    </div>
                                                </div>
                                            )
                                        })}
                                    </div>
                                    <button 
                                        onClick={startGame}
                                        disabled={totalSelected !== totalNames}
                                        className={`btn-normal mt-4 w-full py-4 rounded-xl text-3xl tracking-[2px] transition-all relative z-10 ${totalSelected === totalNames ? 'bg-red-800 hover:bg-red-700 text-white shadow-[0_0_20px_rgba(220,38,38,0.4)] hover:scale-[1.02]' : 'bg-neutral-800 text-gray-600 cursor-not-allowed border border-neutral-700'}`}
                                    >
                                        B·∫ÆT ƒê·∫¶U
                                    </button>
                                </div>
                            </div>
                        </div>
                        {showAddRole && (
                            <AddRoleModal 
                                onClose={()=>setShowAddRole(false)} 
                                onAdd={(newRole) => {
                                    setRolesConfig(prev => [...prev, {
                                        id: `custom_${Date.now()}`,
                                        name: newRole.name, team: newRole.team, desc: newRole.desc,
                                        count: 1, defaultCount: 0, icon: Star,
                                        isDefault: false 
                                    }]);
                                }} 
                            />
                        )}
                    </div>
                );
            }

            if (phase === 'REVEAL') {
                return (
                    <div className="min-h-screen p-6 flex flex-col items-center justify-start pt-12">
                        <h2 className="text-6xl font-spooky text-yellow-500 mb-2 text-glow-yellow tracking-widest text-center">PH√ÅT B√ÄI</h2>
                        <p className="text-gray-500 mb-10 font-serif italic text-center">"M√†n ƒë√™m bu√¥ng xu·ªëng..."</p>
                        
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 w-full max-w-5xl mb-24 pb-safe">
                            {players.map(p => (
                                <button 
                                    key={p.id} 
                                    onClick={() => setRevealId(p.id)} 
                                    className="role-card p-4 md:p-6 rounded-2xl flex flex-col items-center gap-3 hover:border-yellow-600/50 hover:bg-yellow-900/10 transition-all active:scale-95 group relative overflow-hidden"
                                >
                                    <div className="absolute inset-0 bg-gradient-to-br from-transparent to-black/80"></div>
                                    <div className="w-16 h-16 md:w-20 md:h-20 bg-black/50 rounded-full border border-neutral-700 flex items-center justify-center text-gray-600 group-hover:text-yellow-500 group-hover:border-yellow-500 transition-all relative z-10 shadow-lg">
                                        <Users size={32}/>
                                    </div>
                                    <span className="text-xl md:text-2xl font-bold text-gray-300 group-hover:text-white relative z-10 tracking-wide text-center">{p.name}</span>
                                    <span className="text-[10px] font-bold uppercase tracking-widest text-neutral-500 border border-neutral-800 px-3 py-1 rounded-full relative z-10 group-hover:border-yellow-900 group-hover:text-yellow-700">Ch·∫°m ƒë·ªÉ xem</span>
                                </button>
                            ))}
                        </div>
                        
                        <div className="fixed bottom-0 left-0 w-full p-6 bg-black/90 backdrop-blur-md border-t border-red-900/30 flex justify-center z-40 pb-safe">
                            <button 
                                onClick={startMainGame} 
                                className="btn-normal px-8 py-4 md:px-10 md:py-5 bg-gradient-to-r from-red-900 to-red-800 hover:from-red-800 hover:to-red-700 rounded-2xl text-2xl md:text-3xl text-white shadow-[0_0_30px_rgba(220,38,38,0.3)] hover:scale-105 transition-all flex items-center gap-4 tracking-widest border border-red-700"
                            >
                                <Moon size={28}/> V√ÄO ƒê√äM
                            </button>
                        </div>

                        {revealId && (
                            <RevealRoleModal 
                                player={players.find(p => p.id === revealId)}
                                roleConfig={rolesConfig.find(r => r.id === players.find(p => p.id === revealId).roleId)}
                                onClose={() => setRevealId(null)}
                            />
                        )}
                    </div>
                )
            }

            // GAME UI
            const currentStep = activeNightSteps[currentStepIdx] || {};
            const hintIds = (currentStep.roleId) ? players.filter(p => p.roleId === currentStep.roleId).map(p=>p.id) : [];

            return (
                <div className="min-h-screen flex flex-col md:flex-row overflow-hidden bg-black">
                    {/* Control Panel */}
                    <div className={`md:w-96 bg-neutral-900/90 border-r border-neutral-800 flex flex-col ${activeTab==='control'?'flex':'hidden md:flex'} relative z-20 shadow-2xl h-screen md:h-auto`}>
                        <div className="p-6 text-center border-b border-neutral-800 bg-black/40 backdrop-blur relative pt-10 md:pt-6">
                            <h2 className="text-4xl md:text-5xl font-spooky text-red-600 text-glow tracking-widest mb-1">{phase === 'GAME_NIGHT' ? `ƒê√äM TH·ª® ${dayCount}` : `NG√ÄY TH·ª® ${dayCount}`}</h2>
                            <div className="text-xs text-neutral-600 font-bold tracking-[4px] uppercase">Game Control Panel</div>
                            <button onClick={endGame} className="btn-normal absolute top-4 left-4 text-[10px] border border-gray-800 px-2 py-1 rounded text-gray-600 hover:text-red-500 hover:border-red-900 transition-colors uppercase">Tho√°t</button>
                        </div>
                        
                        <div className="flex-1 p-6 overflow-y-auto pb-32 md:pb-6">
                            {phase === 'GAME_NIGHT' ? (
                                <div className="space-y-8 animate-fadeIn">
                                    <div className="text-center mt-4">
                                        <div className="text-4xl md:text-5xl font-bold text-white mb-3 font-spooky tracking-wider text-glow">{currentStep.title}</div>
                                        <div className="text-emerald-400 italic text-lg md:text-xl font-serif bg-emerald-900/10 py-2 rounded-lg border border-emerald-900/30">"{currentStep.msg}"</div>
                                    </div>
                                    
                                    {/* Role Reminder */}
                                    {hintIds.length > 0 && (
                                        <div className="bg-blue-950/30 border border-blue-900/50 p-5 rounded-2xl text-center shadow-inner">
                                            <div className="text-xs text-blue-400 uppercase font-bold mb-4 tracking-[4px]">Ng∆∞·ªùi gi·ªØ vai tr√≤</div>
                                            <div className="flex flex-wrap justify-center gap-3">
                                                {players.filter(p => hintIds.includes(p.id)).map(p => (
                                                    <span key={p.id} className={`text-lg font-bold px-4 py-2 rounded-lg border ${p.isAlive ? 'bg-blue-900/50 border-blue-700 text-white shadow-[0_0_10px_rgba(37,99,235,0.3)]' : 'bg-neutral-800 border-neutral-700 text-gray-600 line-through'}`}>{p.name}</span>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    <div className="text-center text-gray-600 text-sm mt-10 italic">
                                        (Thao t√°c: B·∫•m v√†o th·∫ª ng∆∞·ªùi ch∆°i b√™n ph·∫£i/tab danh s√°ch ƒë·ªÉ th·ª±c hi·ªán h√†nh ƒë·ªông)
                                    </div>

                                    <button onClick={nextStep} className="btn-normal w-full py-5 bg-gradient-to-r from-blue-900 to-blue-800 hover:from-blue-800 hover:to-blue-700 text-white rounded-2xl text-2xl tracking-[2px] shadow-lg shadow-blue-900/30 flex items-center justify-center gap-3 mt-4 hover:scale-[1.02] transition-transform border border-blue-700 active:scale-95">
                                        TI·∫æP T·ª§C <Play size={28}/>
                                    </button>
                                </div>
                            ) : (
                                <div className="space-y-6 animate-fadeIn">
                                    {/* Timer */}
                                    <div className="role-card p-6 md:p-8 rounded-2xl text-center border-neutral-800">
                                        <div className={`text-7xl md:text-8xl font-mono font-bold tracking-tighter ${timer<10?'text-red-500 animate-pulse drop-shadow-[0_0_20px_rgba(220,38,38,0.8)]':'text-white'}`}>
                                            {Math.floor(timer/60)}:{(timer%60).toString().padStart(2,'0')}
                                        </div>
                                        <div className="flex justify-center gap-6 mt-8">
                                            <button onClick={()=>setIsTimerRunning(!isTimerRunning)} className="w-16 h-16 bg-neutral-800 border border-neutral-700 rounded-full flex items-center justify-center hover:bg-neutral-700 hover:border-gray-500 hover:text-white text-gray-400 transition-all shadow-lg active:scale-95">
                                                {isTimerRunning ? <Pause size={32}/> : <Play size={32} className="ml-1"/>}
                                            </button>
                                            <button onClick={()=>{setTimer(120);setIsTimerRunning(false)}} className="w-16 h-16 bg-neutral-800 border border-neutral-700 rounded-full flex items-center justify-center hover:bg-neutral-700 hover:border-gray-500 hover:text-white text-gray-400 transition-all shadow-lg active:scale-95">
                                                <RotateCcw size={32}/>
                                            </button>
                                        </div>
                                        <div className="flex gap-2 justify-center mt-6">
                                            <button onClick={()=>setTimer(t=>t+60)} className="px-3 py-2 bg-neutral-900 border border-neutral-800 rounded-lg text-xs text-gray-500 hover:text-white active:bg-neutral-800">+1m</button>
                                            <button onClick={()=>setTimer(t=>t+30)} className="px-3 py-2 bg-neutral-900 border border-neutral-800 rounded-lg text-xs text-gray-500 hover:text-white active:bg-neutral-800">+30s</button>
                                        </div>
                                    </div>

                                    {/* Morning Report */}
                                    {morningEvents.length > 0 && (
                                        <div className="bg-red-950/20 border border-red-900/40 p-5 rounded-2xl">
                                            <div className="text-red-500 font-bold uppercase text-xs mb-4 flex items-center gap-2 tracking-[2px]"><AlertTriangle size={16}/> C·∫≠p nh·∫≠t bu·ªïi s√°ng</div>
                                            <div className="space-y-3">
                                                {morningEvents.map(e => {
                                                    let colorClass = 'text-gray-400';
                                                    if (e.outcome === 'dead') colorClass = 'text-red-500 font-bold animate-pulse';
                                                    if (e.outcome === 'saved') colorClass = 'text-green-500 font-bold';
                                                    if (e.outcome === 'transform') colorClass = 'text-purple-500 font-bold';
                                                    if (e.outcome === 'damaged') colorClass = 'text-yellow-500 font-bold';

                                                    return (
                                                        <div key={e.id} className="flex justify-between items-center bg-black/60 p-3 rounded-lg border border-neutral-800">
                                                            <div>
                                                                <span className="font-bold text-xl block tracking-wide">{e.name}</span>
                                                                <span className={`text-[10px] uppercase font-bold tracking-wider ${colorClass}`}>
                                                                    {e.outcomeMsg}
                                                                </span>
                                                            </div>
                                                            {e.action === 'kill' && (
                                                                <button 
                                                                    onClick={() => {
                                                                        if(confirm(`Khai t·ª≠ ${e.name}?`)) {
                                                                            setPlayers(prev => prev.map(p => p.id === e.id ? { ...p, isAlive: false } : p));
                                                                        }
                                                                    }}
                                                                    className="btn-normal bg-red-700 hover:bg-red-600 text-white text-xs font-bold px-3 py-2 rounded shadow-lg uppercase flex items-center gap-1 active:scale-95"
                                                                >
                                                                    <Skull size={12}/> KHAI T·ª¨
                                                                </button>
                                                            )}
                                                            {e.action === 'damage' && (
                                                                <button 
                                                                    onClick={() => setPlayers(prev => prev.map(p => p.id === e.id ? { ...p, hp: p.hp - 1 } : p))}
                                                                    className="btn-normal bg-yellow-700 hover:bg-yellow-600 text-white text-xs font-bold px-3 py-2 rounded shadow-lg uppercase active:scale-95"
                                                                >
                                                                    TR·ª™ M·∫†NG
                                                                </button>
                                                            )}
                                                            {e.action === 'transform' && (
                                                                <button 
                                                                    onClick={() => setPlayers(prev => prev.map(p => p.id === e.id ? { ...p, roleId: 'werewolf' } : p))}
                                                                    className="btn-normal bg-purple-700 hover:bg-purple-600 text-white text-xs font-bold px-3 py-2 rounded shadow-lg uppercase active:scale-95"
                                                                >
                                                                    H√ìA S√ìI
                                                                </button>
                                                            )}
                                                        </div>
                                                    )
                                                })}
                                            </div>
                                        </div>
                                    )}

                                    {/* Graveyard */}
                                    {deadPlayers.length > 0 && (
                                        <div className="bg-neutral-900/50 border border-neutral-800 p-5 rounded-2xl">
                                            <div className="text-gray-500 font-bold uppercase text-xs mb-4 flex items-center gap-2 tracking-[2px]"><Ghost size={16}/> Danh s√°ch ng∆∞·ªùi ch·∫øt</div>
                                            <div className="space-y-2">
                                                {deadPlayers.map(p => (
                                                    <div key={p.id} className="flex justify-between items-center bg-black/40 p-3 rounded-lg border border-neutral-800/50">
                                                        <span className="font-bold text-gray-500 line-through text-lg">{p.name}</span>
                                                        <button 
                                                            onClick={() => {
                                                                if(confirm(`H·ªìi sinh ${p.name}?`)) {
                                                                    setPlayers(prev => prev.map(x => x.id === p.id ? { ...x, isAlive: true } : x));
                                                                }
                                                            }}
                                                            className="btn-normal bg-green-900/30 hover:bg-green-800/50 text-green-500 border border-green-900 text-[10px] font-bold px-3 py-2 rounded uppercase flex items-center gap-1 transition-colors active:scale-95"
                                                        >
                                                            <RotateCcw size={10}/> H·ªíI SINH
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    <button onClick={endDay} className="btn-normal w-full py-5 bg-purple-900 hover:bg-purple-800 rounded-2xl text-2xl tracking-[2px] border border-purple-700 shadow-lg shadow-purple-900/30 text-white mt-4 transition-all hover:scale-[1.02] active:scale-95">
                                        V√ÄO BAN ƒê√äM
                                    </button>
                                    
                                    <button onClick={clearNightTags} className="btn-normal w-full py-3 bg-neutral-800 hover:bg-neutral-700 rounded-xl text-gray-400 border border-neutral-700 flex items-center justify-center gap-2 transition-all text-xs tracking-wider active:scale-95">
                                        <Refresh size={16}/> Qu√©t S·∫°ch Tr·∫°ng Th√°i (Reset)
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Players List (Grid) */}
                    <div className={`flex-1 bg-black p-4 md:p-6 overflow-y-auto ${activeTab==='players'?'block':'hidden md:block'} relative pb-32 md:pb-6`}>
                        <div className="absolute inset-0 pointer-events-none bg-[url('https://www.transparenttextures.com/patterns/black-felt.png')] opacity-20"></div>
                        <div className="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 relative z-10 pt-4 md:pt-0">
                            {players.filter(p=>showDead||p.isAlive).map(p => {
                                const r = rolesConfig.find(x=>x.id===p.roleId);
                                const isDead = !p.isAlive;
                                return (
                                    <div key={p.id} onClick={()=>setEditingPlayer(p)} className={`role-card p-4 rounded-xl relative group cursor-pointer transition-all hover:border-gray-500 hover:bg-neutral-800 active:scale-95 ${isDead ? 'opacity-40 grayscale' : 'hover:-translate-y-1 hover:shadow-xl'}`}>
                                        <div className="flex items-center gap-3 mb-3">
                                            <div className={`w-10 h-10 md:w-12 md:h-12 rounded-xl flex items-center justify-center shadow-lg border border-white/5 ${r.team==='bad'?'bg-red-900/20 text-red-500':(r.team==='neutral'?'bg-yellow-900/20 text-yellow-500':'bg-blue-900/20 text-blue-500')}`}>
                                                {r.icon?<r.icon size={20}/>:<Users size={20}/>}
                                            </div>
                                            <div className="overflow-hidden flex-1">
                                                <div className={`font-bold text-lg md:text-xl truncate tracking-wide ${isDead ? 'line-through text-gray-600' : 'text-gray-200 group-hover:text-white'}`}>{p.name}</div>
                                                <div className={`text-[10px] font-bold uppercase tracking-wider ${r.team==='bad'?'text-red-600':(r.team==='neutral'?'text-yellow-600':'text-blue-600')}`}>{r.name}</div>
                                            </div>
                                            <Settings size={16} className="text-gray-700 group-hover:text-gray-400"/>
                                        </div>
                                        
                                        {/* Status Tags Display */}
                                        <div className="flex flex-wrap gap-1 min-h-[24px]">
                                            {p.hp > 1 && <span className="text-[9px] font-bold px-2 py-0.5 rounded bg-green-900/30 text-green-400 border border-green-900/50">HP: {p.hp}</span>}
                                            {p.tags.map(t => {
                                                const tagDef = statusTags.find(x=>x.id===t);
                                                return tagDef ? <span key={t} className="text-lg" title={tagDef.label}>{tagDef.emoji}</span> : null;
                                            })}
                                        </div>

                                        {/* Dead Overlay */}
                                        {isDead && (
                                            <div className="absolute top-2 right-2 text-red-900 opacity-80 animate-pulse-slow">
                                                <Skull size={24}/>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    
                    {/* Mobile Tabs */}
                    <div className="md:hidden fixed bottom-0 w-full flex bg-neutral-900/95 backdrop-blur border-t border-neutral-800 z-50 pb-safe">
                        <button onClick={()=>setActiveTab('control')} className={`btn-normal flex-1 py-4 text-sm tracking-widest ${activeTab==='control'?'text-red-500 bg-red-900/10':'text-gray-500'}`}>ƒêI·ªÄU KHI·ªÇN</button>
                        <button onClick={()=>setActiveTab('players')} className={`btn-normal flex-1 py-4 text-sm tracking-widest ${activeTab==='players'?'text-red-500 bg-red-900/10':'text-gray-500'}`}>DANH S√ÅCH</button>
                    </div>

                    {/* Modals */}
                    {editingPlayer && (
                        <PlayerActionModal 
                            player={editingPlayer}
                            roles={rolesConfig}
                            tags={statusTags}
                            onAddTag={addCustomTag}
                            onClose={() => setEditingPlayer(null)}
                            onUpdate={(id, data) => setPlayers(prev => prev.map(p => p.id === id ? { ...p, ...data } : p))}
                            onKill={(id) => {
                                setPlayers(prev => prev.map(p => p.id === id ? { ...p, isAlive: false } : p));
                            }}
                            onRevive={(id) => {
                                setPlayers(prev => prev.map(p => p.id === id ? { ...p, isAlive: true } : p));
                            }}
                        />
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
